{% extends "base.html" %}
{% block title %}AI Companion - Speech Practice Coach{% endblock %}

{% block content %}
<section class="page-section" style="background-color: var(--bg-light);">
  <div class="container" style="max-width: 900px;">
    <header style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">AI Companion</h1>
      <p style="font-size: 1.1rem; color: var(--text-light);">
        Share your thoughts and AI Companion will craft a concise, spoken response tailored to your prompt.
      </p>
    </header>

    <div class="card" style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.3rem; margin-bottom: 1rem;">Recorder</h2>
      <p style="color: var(--text-light); margin-bottom: 1.5rem;">
        Start the recorder, speak naturally, then stop to let AI Companion analyse and respond.
      </p>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <button id="aiStart" class="btn btn-primary" style="flex: 1; min-width: 200px;">Start Recording</button>
        <button id="aiStop" class="btn" style="flex: 1; min-width: 200px; background-color: #6c757d; color: white; cursor: not-allowed;" disabled>Stop Recording</button>
      </div>
      <p id="aiStatus" style="color: var(--text-light); font-size: 0.9rem;">Waiting to record...</p>
    </div>

    <div style="display: flex; flex-direction: column; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
      <div style="position: relative; width: 100%; max-width: 400px;">
        <img id="aiAvatar" src="{{ url_for('static', filename='media/an.png') }}" alt="AI Companion guide" style="width: 100%; border-radius: 20px; box-shadow: var(--shadow);" loading="lazy">
        <video id="aiVideo" style="width: 100%; border-radius: 20px; box-shadow: var(--shadow);" src="{{ url_for('static', filename='video/demo.mp4') }}" loop muted playsinline hidden></video>
      </div>
      <audio id="aiAudio" style="width: 100%; max-width: 400px;" controls hidden></audio>
    </div>

    <div class="card">
      <h2 style="font-size: 1.3rem; margin-bottom: 1rem;">How it works</h2>
      <ol style="padding-left: 1.5rem; color: var(--text-light); line-height: 1.8;">
        <li>Tap <strong>Start Recording</strong> and share your question or topic.</li>
        <li>Stop the capture to send audio to AI Companion for transcription and analysis.</li>
        <li>Listen to the generated guidance while the preview video plays.</li>
      </ol>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  (() => {
    const startBtn = document.getElementById('aiStart');
    const stopBtn = document.getElementById('aiStop');
    const statusEl = document.getElementById('aiStatus');
    const audioEl = document.getElementById('aiAudio');
    const videoEl = document.getElementById('aiVideo');
    const avatarEl = document.getElementById('aiAvatar');
    const cleanupUrl = '{{ url_for("ai.cleanup_audio") }}';

    let mediaRecorder;
    let chunks = [];
    let currentAudioFile = null;

    const cleanupCurrentAudio = async (options = {}) => {
      if (!currentAudioFile) return;
      const filename = currentAudioFile;
      const requestInit = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename }),
      };
      if (options.keepalive) {
        requestInit.keepalive = true;
      }
      try {
        await fetch(cleanupUrl, requestInit);
      } catch (error) {
        if (!options.silent) {
          console.error('Audio cleanup failed', error);
        }
      } finally {
        if (currentAudioFile === filename) {
          currentAudioFile = null;
        }
      }
    };

    function showVideo() {
      if (avatarEl) {
        avatarEl.hidden = true;
      }
      if (videoEl) {
        videoEl.hidden = false;
        videoEl.currentTime = 0;
        videoEl.play().catch(() => {});
      }
    }

    function hideVideo() {
      if (videoEl) {
        videoEl.pause();
        videoEl.currentTime = 0;
        videoEl.hidden = true;
      }
      if (avatarEl) {
        avatarEl.hidden = false;
      }
    }

    function resetAudio() {
      if (!audioEl) return;
      audioEl.pause();
      audioEl.currentTime = 0;
      audioEl.hidden = true;
      audioEl.removeAttribute('src');
      audioEl.load();
      audioEl.onplay = null;
      audioEl.onended = null;
      audioEl.onpause = null;
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        await cleanupCurrentAudio({ silent: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            chunks.push(event.data);
          }
        };
        mediaRecorder.onstop = handleStop;
        mediaRecorder.start();
        resetAudio();
        hideVideo();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        stopBtn.style.backgroundColor = 'var(--accent-color)';
        stopBtn.style.cursor = 'pointer';
        statusEl.textContent = 'Recording - tap stop when you are done.';
      } catch (error) {
        statusEl.textContent = 'Unable to access microphone.';
        console.error(error);
      }
    }

    async function handleStop() {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append('audio_data', blob, 'input.webm');
      statusEl.textContent = 'Processing response...';

      try {
        const response = await fetch('{{ url_for('ai.process_audio') }}', {
          method: 'POST',
          body: formData,
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Processing failed');
        }

        if (payload.audio_url) {
          currentAudioFile = payload.audio_filename || null;
          audioEl.src = payload.audio_url;
          audioEl.hidden = false;
          audioEl.onplay = () => {
            showVideo();
            statusEl.textContent = 'Playing response...';
          };
          audioEl.onended = async () => {
            hideVideo();
            statusEl.textContent = 'Ready for another recording.';
            await cleanupCurrentAudio();
            resetAudio();
          };
          audioEl.onpause = () => {
            if (!audioEl.ended) {
              hideVideo();
              statusEl.textContent = 'Playback paused.';
            }
          };
          audioEl.play().catch(() => {
            hideVideo();
            statusEl.textContent = 'Response ready. Tap play to listen.';
          });
        } else {
          hideVideo();
          statusEl.textContent = 'Ready for another recording.';
        }
      } catch (error) {
        statusEl.textContent = error.message;
        await cleanupCurrentAudio({ silent: true });
        resetAudio();
        hideVideo();
        console.error(error);
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        stopBtn.style.backgroundColor = '#6c757d';
        stopBtn.style.cursor = 'not-allowed';
      }
    }

    startBtn?.addEventListener('click', startRecording);
    stopBtn?.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    });

    window.addEventListener('beforeunload', () => {
      if (!currentAudioFile) return;
      try {
        const payload = JSON.stringify({ filename: currentAudioFile });
        const beaconData = new Blob([payload], { type: 'application/json' });
        navigator.sendBeacon(cleanupUrl, beaconData);
      } catch (error) {
        // Ignore cleanup errors on unload
      }
    });
  })();
</script>
{% endblock %}
